---
title: "Get patients' characteristics"
author: "Martí Català, Mike Du, Yuchen Guo, Kim Lopez-Guell, Xintong Li, Núria Mercadé-Besora, and Edward Burn"
date: "`r Sys.Date()`"
output: 
  html_document:
    pandoc_args: [
      "--number-offset=1,0"
      ]
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{Get cohort patients characteristics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

In this vignette we show different functions to get characteristics (e.g. age, sex, prior history...) of subjects in OMOP CDM tables and cohort tables.  This can be useful when doing explanatory analysis as well as calling these functions for more complex analyses.

The PatientProfiles package is designed to work with data in the OMOP CDM format, so our first step is to create a reference to the data using the DBI and CDMConnector packages. The connection to a Postgres database would look like:

```{r, eval=FALSE}
library(DBI)
library(CDMConnector)

# The input arguments provided are for illustrative purposes only and do not provide access to any database.

con <- DBI::dbConnect(RPostgres::Postgres(),
                      dbname = "omop_cdm",          
                      host = "10.80.192.00",
                      user = "user_name",
                      password = "user_pasword"
)

cdm <- CDMConnector::cdm_from_con(con,
                                  cdm_schema = "main",
                                  write_schema = "main",
                                  cohort_tables = "cohort_example"
)
```

For this example we will work with simulated data generated by the `mockPatientProfiles()` function provided in this package, which mimics a database formatted in OMOP:

```{r, message= FALSE, warning=FALSE}
library(PatientProfiles)
library(duckdb)
library(tibble)
library(dplyr)

cdm <- mockPatientProfiles(
  patient_size = 1000, 
  drug_exposure_size = 1000
)
                         
```

## Example: get characteristics in tables

`addAge()`: adds a new column to the input table containing each patient's age at a certain date, specified in indexDate. Function allows to set month and/or day of birth to patients with missings or it can be imposed to all subjects.
Further, the function can classify patient's into different age groups based on the argument ageGroup.

Suppose we want to calculate the age at condition start date for records in the condition_ocurrence table. Also, we wan to group patients in 20-year age band and if they are 60 years old or more.

```{r, message= FALSE, warning=FALSE}
cdm$condition_occurrence_mod <- cdm$condition_occurrence %>%
  addAge(
    cdm = cdm,
    ageDefaultMonth = 1,
    ageDefaultDay = 6,
    indexDate = "condition_start_date",
    ageGroup = list("ageBand_20" = 
                      list("0 to 19"  = c(0, 19), 
                           "20 to 39" = c(20, 39), 
                           "40 to 59" = c(40, 59), 
                           "60 to 79" = c(60, 79), 
                           "80 to 99" = c(80, 99),
                           ">= 100"   = c(100, 150)
                      ),
                    "ageThreshold_60" = 
                      list("less60" = c(0,59),
                           "more60" = c(60,150)
                      )
    )
  )

```


`addSex()`: appends a column to the input table indicating the sex for each patient as "Female" or "Male". 

First, we can add the sex of the patients to the table. This information can be used to count the occurrences of the condition_concept_id = 5 in males aged 60 years or older. We can also stratify the number of events by age, grouping patients into 20-year age bands.

```{r, message= FALSE, warning=FALSE}
cdm$condition_occurrence_mod <- cdm$condition_occurrence_mod %>%
  addSex(
    cdm = cdm
  )

num_conditions <- cdm$condition_occurrence_mod %>%
  filter(
    sex == "Male"
  ) %>%
  filter(
    ageThreshold_60 == "more60"
  ) %>%
  filter(
    condition_concept_id  == 5
  ) %>%
  group_by(
    ageBand_20
  ) %>%
  summarise(
    n = count(condition_occurrence_id)
  )
```

## Example: get characteristics in cohort tables

PatientProfiles functions can be used on both OMOP CDM tables and cohort tables. In this example we will see some of the package functionalities applied to a cohort table:


`addInObservation()`: adds a new binary column to the input table, indicating whether the subjects are being observed at a specific time. 

`addPriorHistory()`: appends a column to the input table containing the number of days each patient has been in observation up to a specified date. 

`addFutureObservation()`: adds a column with the days of future observation for an individual at a certain date


We can use the first function to obtain patients which are in observation at "cohort_start_date" and subsequently get their prior and future observation days. Notice that we are not using the argument "indexDate", since it is already defaulted to "cohort_start_date".


```{r, message= FALSE, warning=FALSE}
cdm$cohort1 <- cdm$cohort1 %>%
  addInObservation(
    cdm = cdm
  ) %>%
  filter(
    in_observation == 1
  ) %>%
  addPriorHistory(
    cdm = cdm
  ) %>%
  addFutureObservation(
    cdm = cdm
  )
```

If the database allows for multiple observation periods, it's important to note that the results of the previous functions will be based on the period where "indexDate" falls within. If a patient is not under observation at the specified date, `addPriorHistory()` and `addFutureObservation()` functions will return NA.

## Example: get all characteristics at once

`addDemographics()`:  can be used to add all the features presented in this vignette (except for `addInObservation()`) at once, in both tables and cohort tables.

If we want to get the age, sex and prior history of individuals at the day they enter a cohort, we can use the function `addDemographics()` as follows

```{r, message= FALSE, warning=FALSE}
cdm$cohort2 <- cdm$cohort2 %>%
  addDemographics(
    cdm = cdm,
    age = TRUE,
    ageName = "age",
    ageGroup = NULL,
    sex = TRUE,
    sexName = "sex",
    priorHistory = TRUE,
    priorHistoryName = "prior_history",
    futureObservation = FALSE,
  )
```



---
title: "Get characterics using PatientProfiles"
author: "Marti Catala, Mike Du, Yuchen Guo and Kim Lopez-Guell"
date: "`r Sys.Date()`"
output: 
  html_document:
    pandoc_args: [
      "--number-offset=1,0"
      ]
    number_sections: yes
    toc: yes
vignette: >
  %\VignetteIndexEntry{Get characterics using PatientProfiles}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
library(PatientProfiles)
```

## Introduction

In this vignette we show several different functions to get characteristics like age, sex, prior history.. This can be useful when doing explanatory analysis as well as calling these functions for more complex analyses.


## Examples: addAge and addAgeGroup function

addAge function: add age as a column to your cohort table. You can choose how to impute missing month and day of birth by changing defaultMonth and defaultDay. Or you can use imposeMonth/imposeDay, then all month/day of birth will be considered as missing and impute.

First, relevant libraries and mock data are created for demonstration. This package uses data mapped to the OMOP CDM, which can be created using CDMConnector package using something like:

```{r, eval=FALSE}
library(DBI)
library(CDMConnector)
library(PatientProfiles)
con <- DBI::dbConnect(RPostgres::Postgres(),
                      dbname = Sys.getenv("CDM5_POSTGRESQL_DBNAME"),
                      host = Sys.getenv("CDM5_POSTGRESQL_HOST"),
                      user = Sys.getenv("CDM5_POSTGRESQL_USER"),
                      password = Sys.getenv("CDM5_POSTGRESQL_PASSWORD"))
cdm <- CDMConnector::cdm_from_con(con,
                                  cdm_schema = Sys.getenv("CDM5_POSTGRESQL_CDM_SCHEMA"))
```
We use mock data generated by function mockPatientProfiles() within this package to demonstrate this example.
```{r, message= FALSE, warning=FALSE}
library(DBI)
library(duckdb)
library(tibble)
library(PatientProfiles)
cohort1 <- tibble::tibble(
  cohort_definition_id = 1,
  subject_id = c("1", "2", "3"),
  cohort_start_date = c(
    as.Date("2010-01-01"), as.Date("2010-01-01"), as.Date("2010-01-01")
  ),
  cohort_end_date = c(
    as.Date("2015-01-01"), as.Date("2013-01-01"), as.Date("2018-01-01")
  )
)
person <- tibble::tibble(
  person_id = c("1", "2", "3"),
  gender_concept_id = c("8507", "8532", "8507"),
  year_of_birth = c(1980, 1990, 2000),
  month_of_birth = c(NA, 07, 08),
  day_of_birth = c(01, 25, 03)
)
cdm <- mockPatientProfiles(person = person, cohort1 = cohort1)
```
After getting the cdm object, we can then run the function addAge().
```{r, message= FALSE, warning=FALSE}
cdm$cohort1 %>% addAge(cdm = cdm, ageDefaultMonth = 12, ageDefaultDay = 3)
```
After getting age for your cohort, addAgeGroup function can add age group to the cohort. In this case, age column is not provided in x, age will automatically computed by addAge function. So x needs to be in cdm to get the age computed. Output of addAgeGroup will be the same table as previous addAge example with one extra column: ageGroupNames. Here, as ageGroupNames is not provided, default setting of the function will combine ageGroup provided.
```{r, message= FALSE, warning=FALSE}
cdm$cohort1 %>% 
  addAge(cdm = cdm, ageGroup = list(c(0, 29), c(30, 59), c(60, 150)))
```
Also can be computed using addCategories
```{r, message=FALSE, warning=FALSE}
cdm$cohort1 %>%
  addAge(cdm) %>%
  addCategories(
    "age",
    list("age_group" = list(c(0, 29), c(30, 59), c(60, 150)))
  )
```
